---
- name: Set DNS Google nameserver
  shell: |
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf
  become: true

- name: FRR_interfaces packages installation
  yum:
    name:
      - python-netaddr
      - tcpdump
      - net-tools
      - traceroute
      - git
      - cmake
      - gcc
      - flex
      - bison
      - rpm-build
      - autoconf
      - automake
      - libtool
      - make
      - readline-devel
      - texinfo
      - net-snmp-devel
      - groff
      - pkgconfig
      - json-c-devel
      - pam-devel
      - pytest
      - c-ares-devel
      - python-devel
      - systemd-devel
      - python-sphinx
      - libcap-devel
    state: present
  become: true
  check_mode: no

- name: Update system
  yum:
    name: "*"
    state: latest
  become: true

- name: Install libyang
  shell: |
    git clone https://github.com/CESNET/libyang.git
    cd libyang
    mkdir build; cd build
    cmake -DENABLE_CACHE=OFF -DENABLE_LYD_PRIV=ON -DCMAKE_INSTALL_PREFIX:PATH=/usr -D CMAKE_BUILD_TYPE:String="Release" ..
    make
    make install
  become: true

- name: Install FRR
  shell: |
    groupadd -g 92 frr
    groupadd -r -g 85 frrvty
    useradd -u 92 -g 92 -M -r -G frrvty -s /sbin/nologin  -c "FRR FRRouting suite" -d /var/run/frr frr
    git clone https://github.com/frrouting/frr.git frr
    cd frr
    git checkout stable/7.2
    ./bootstrap.sh
    ./configure --bindir=/usr/bin --sbindir=/usr/lib/frr --sysconfdir=/etc/frr --libdir=/usr/lib/frr --libexecdir=/usr/lib/frr --localstatedir=/var/run/frr --with-moduledir=/usr/lib/frr/modules --enable-snmp=agentx --enable-multipath=64 --enable-user=frr --enable-group=frr --enable-vty-group=frrvty --enable-systemd=yes --disable-exampledir --disable-ldpd --enable-fpm --with-pkg-git-version --with-pkg-extra-version=-MyOwnFRRVersion SPHINXBUILD=/usr/bin/sphinx-build
    make
    make check
    make install
    sudo mkdir /var/log/frr
    mkdir /etc/frr
    touch /etc/frr/zebra.conf
    touch /etc/frr/bgpd.conf
    touch /etc/frr/ospfd.conf
    touch /etc/frr/ospf6d.conf
    touch /etc/frr/isisd.conf
    touch /etc/frr/ripd.conf
    touch /etc/frr/ripngd.conf
    touch /etc/frr/pimd.conf
    touch /etc/frr/nhrpd.conf
    touch /etc/frr/eigrpd.conf
    touch /etc/frr/babeld.conf
    chown -R frr:frr /etc/frr/
    touch /etc/frr/vtysh.conf
    chown frr:frrvty /etc/frr/vtysh.conf
    chmod 640 /etc/frr/*.conf
    touch /etc/frr/daemons
    chown frr:frr /etc/frr/daemons
    install -p -m 644 tools/frr.service /usr/lib/systemd/system/frr.service
    systemctl daemon-reload
    systemctl preset frr.service
    systemctl enable frr
  become: true

- name: Set sysctl options
  template:
    src: 99-sysctl.conf.j2
    dest: /etc/sysctl.d/99-frr.conf
  become: true

- name: Reload sysctl files
  shell: /sbin/sysctl -p
  become: true

- name: Configure frr daemons file
  tags: frr_common
  template:
    src: "{{ ansible_hostname }}_daemons.j2"
    dest: /etc/frr/daemons
  become: yes
  become_user: frr

- name: Overwrite /etc/frr/zebra.conf with updated hostname
  template:
    src: "{{ ansible_hostname }}_zebra.conf.j2"
    dest: /etc/frr/zebra.conf
  become: true

- name: Configure frr vtysh config file
  tags: frr_common
  template:
    src: "{{ ansible_hostname }}_vtysh.conf.j2"
    dest: /etc/frr/vtysh.conf
  become: yes
  become_user: frr

- name: Create /etc/frr/bgpd.conf
  template:
    src: "{{ ansible_hostname}}_bgpd.conf.j2"
    dest: /etc/frr/bgpd.conf
  become: true
  become_user: frr

- name: Enable bgpd in /etc/frr/daemons
  lineinfile:
    path: /etc/frr/daemons
    regexp: '^bgpd='
    line: bgpd=yes
  become: true

- name: Enable FRR service
  shell: /bin/systemctl enable frr
  become: true

- name: Restart FRR
  systemd:
    name: frr
    state: started
  become: true

